{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAG Player - Reprodutor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body data-page="player">
    <div class="player-wrapper">
        <div class="cassette-player">
            <div class="cassette-container">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 810 513.5" class="cassette-svg">
                    <defs>
                        <filter id="subtleBlueGlow" x="-20%" y="-20%" width="140%" height="140%">
                            <feColorMatrix type="matrix" values="0.1 0.1 0.3 0 0.05
                                                                 0.1 0.2 0.4 0 0.1  
                                                                 0.2 0.3 0.6 0 0.15
                                                                 0   0   0   1 0" result="blueish" />
                            <feGaussianBlur in="blueish" stdDeviation="1.5" result="blur" />
                            <feMerge>
                                <feMergeNode in="blur" />
                                <feMergeNode in="SourceGraphic" />
                            </feMerge>
                        </filter>
                    </defs>
                    <g id="Tape">
                        <g id="Tape1">
                            <g id="TapeReel">
                                <circle cx="234" cy="234" r="160" fill="#1a1a1a" class="tape-reel tape1-main"
                                    id="tape1-main"></circle>
                                <circle cx="234" cy="234" r="140" stroke="#333" fill="none"
                                    class="tape-reel tape1-ring1" id="tape1-ring1"></circle>
                                <circle cx="234" cy="234" r="120" stroke="#333" fill="none"
                                    class="tape-reel tape1-ring2" id="tape1-ring2"></circle>
                                <circle cx="234" cy="234" r="100" stroke="#333" fill="none"
                                    class="tape-reel tape1-ring3" id="tape1-ring3"></circle>
                            </g>
                            <circle cx="234" cy="234" r="86.05" fill="#f2f2f2" />
                            <circle cx="234" cy="234" r="40.49" fill="#bfbfbf" />
                            <rect x="246.52" y="198.18" width="10.12" height="10.12"
                                transform="translate(133.98 -98.04) rotate(29.74)" fill="#f2f2f2" />
                            <rect x="211.36" y="259.7" width="10.12" height="10.12"
                                transform="translate(159.87 -72.49) rotate(29.74)" fill="#f2f2f2" />
                            <rect x="264.37" y="228.74" width="10.12" height="10.12"
                                transform="translate(501.7 -36.95) rotate(89.68)" fill="#f2f2f2" />
                            <rect x="193.51" y="229.14" width="10.12" height="10.12"
                                transform="translate(431.64 34.31) rotate(89.68)" fill="#f2f2f2" />
                            <rect x="210.95" y="198.41" width="10.12" height="10.12"
                                transform="translate(-73.39 137.84) rotate(-30.51)" fill="#f2f2f2" />
                            <rect x="246.93" y="259.46" width="10.12" height="10.12"
                                transform="translate(-99.41 164.56) rotate(-30.51)" fill="#f2f2f2" />
                            <circle cx="234" cy="234" r="24.18" fill="#1a1a1a" />
                            <polygon points="234 198.38 203.15 251.81 264.85 251.81 234 198.38" fill="#1a1a1a" />
                            <line x1="234" y1="198.38" x2="234" y2="234" fill="none" stroke="#f2f2f2"
                                stroke-miterlimit="10" />
                            <line x1="203.15" y1="251.81" x2="234" y2="234" fill="none" stroke="#f2f2f2"
                                stroke-miterlimit="10" />
                            <line x1="264.85" y1="251.81" x2="234" y2="234" fill="none" stroke="#f2f2f2"
                                stroke-miterlimit="10" />
                        </g>
                        <g id="Tape2">
                            <g id="TapeReel2">
                                <circle cx="576" cy="234" r="85" fill="#1a1a1a" class="tape-reel tape2-main"
                                    id="tape2-main"></circle>
                                <circle cx="576" cy="234" r="65" stroke="#333" fill="none" class="tape-reel tape2-ring1"
                                    id="tape2-ring1"></circle>
                                <circle cx="576" cy="234" r="45" stroke="#333" fill="none" class="tape-reel tape2-ring2"
                                    id="tape2-ring2"></circle>
                                <circle cx="576" cy="234" r="25" stroke="#333" fill="none" class="tape-reel tape2-ring3"
                                    id="tape2-ring3"></circle>
                            </g>
                            <circle cx="576" cy="234" r="86.05" fill="#f2f2f2" />
                            <circle cx="576" cy="234" r="40.49" fill="#bfbfbf" />
                            <rect x="588.52" y="198.18" width="10.12" height="10.12"
                                transform="translate(179.04 -267.72) rotate(29.74)" fill="#f2f2f2" />
                            <rect x="553.36" y="259.7" width="10.12" height="10.12"
                                transform="translate(204.94 -242.17) rotate(29.74)" fill="#f2f2f2" />
                            <rect x="606.37" y="228.74" width="10.12" height="10.12"
                                transform="translate(841.77 -378.94) rotate(89.68)" fill="#f2f2f2" />
                            <rect x="535.51" y="229.14" width="10.12" height="10.12"
                                transform="translate(771.71 -307.68) rotate(89.68)" fill="#f2f2f2" />
                            <rect x="552.95" y="198.41" width="10.12" height="10.12"
                                transform="translate(-26.04 311.47) rotate(-30.51)" fill="#f2f2f2" />
                            <rect x="588.93" y="259.46" width="10.12" height="10.12"
                                transform="translate(-52.05 338.19) rotate(-30.51)" fill="#f2f2f2" />
                            <circle cx="576" cy="234" r="24.18" fill="#1a1a1a" />
                            <polygon points="576 198.38 545.15 251.81 606.85 251.81 576 198.38" fill="#1a1a1a" />
                            <line x1="576" y1="198.38" x2="576" y2="234" fill="none" stroke="#f2f2f2"
                                stroke-miterlimit="10" />
                            <line x1="545.15" y1="251.81" x2="576" y2="234" fill="none" stroke="#f2f2f2"
                                stroke-miterlimit="10" />
                            <line x1="606.85" y1="251.81" x2="576" y2="234" fill="none" stroke="#f2f2f2"
                                stroke-miterlimit="10" />
                        </g>
                    </g>
                    <g id="Cassette">
                        <path
                            d="M780.41,0H29.59A20.59,20.59,0,0,0,9,20.59V483.41A20.59,20.59,0,0,0,29.59,504H780.41A20.59,20.59,0,0,0,801,483.41V20.59A20.59,20.59,0,0,0,780.41,0ZM297,189H513v90H297ZM220.5,486A13.5,13.5,0,1,1,234,472.5,13.49,13.49,0,0,1,220.5,486ZM234,279a45,45,0,1,1,45-45A45,45,0,0,1,234,279Zm58.5,198A13.5,13.5,0,1,1,306,463.5,13.49,13.49,0,0,1,292.5,477Zm225,0A13.5,13.5,0,1,1,531,463.5,13.49,13.49,0,0,1,517.5,477Zm72,9A13.5,13.5,0,1,1,603,472.5,13.49,13.49,0,0,1,589.5,486ZM576,279a45,45,0,1,1,45-45A45,45,0,0,1,576,279Z"
                            fill="#2a2e32" filter="url(#subtleBlueGlow)" />
                        <path
                            d="M654.47,501.21,631.65,394.7a9.74,9.74,0,0,0-9.53-7.7H187.88a9.74,9.74,0,0,0-9.53,7.7L155.53,501.21A9.74,9.74,0,0,0,165.06,513H644.94A9.74,9.74,0,0,0,654.47,501.21ZM220.5,486A13.5,13.5,0,1,1,234,472.5,13.49,13.49,0,0,1,220.5,486Zm72-9A13.5,13.5,0,1,1,306,463.5,13.49,13.49,0,0,1,292.5,477Zm225,0A13.5,13.5,0,1,1,531,463.5,13.49,13.49,0,0,1,517.5,477Zm72,9A13.5,13.5,0,1,1,603,472.5,13.49,13.49,0,0,1,589.5,486Z"
                            fill="#2a2e32" stroke="#c5d1d6" stroke-miterlimit="10" filter="url(#subtleBlueGlow)" />
                        <rect x="297" y="189" width="216" height="90" fill="#2a2e32" opacity="0.67" />
                        <rect y="288" width="18" height="144" rx="3.98" fill="#2a2e32" />
                        <rect x="792" y="288" width="18" height="144" rx="3.98" fill="#2a2e32" />
                    </g>
                    <g id="Label">
                        <path d="M45,36V369H765V36ZM648,297H162V171H648Z" fill="#bfbfbf" />
                        <rect x="45" y="36" width="720" height="27" fill="#ec1d25" />
                        <rect x="45" y="63" width="720" height="81" fill="#f2f2f2" />
                        <rect x="45" y="315" width="720" height="54" fill="#1a1a1a" />
                        <!-- MAG Player Label -->
                        <text x="405" y="55" text-anchor="middle" fill="white" font-family="Arial, sans-serif"
                            font-size="18" font-weight="bold">MAG PLAYER</text>
                        <text x="405" y="110" text-anchor="middle" fill="#333" font-family="Arial, sans-serif"
                            font-size="12" id="songTitle">Selecione um arquivo .mag</text>
                        <text x="405" y="125" text-anchor="middle" fill="#666" font-family="Arial, sans-serif"
                            font-size="10" id="songInfo">Reprodutor de Audio Digital</text>
                    </g>
                </svg>
            </div>

            <div class="controls-panel">
                <div class="main-controls">
                    <button id="openBtn" class="minimal-btn open-btn" title="Abrir arquivo">
                        <i class="fas fa-folder-open"></i>
                    </button>

                    <button id="viewFilesBtn" class="minimal-btn" title="Ver Arquivos" style="display:none;">
                        <i class="fas fa-file-alt"></i>
                    </button>

                    <button id="rewindBtn" class="minimal-btn rewind-btn" disabled title="Retroceder 10s">
                        <i class="fas fa-backward-step"></i>
                    </button>

                    <button id="playPauseBtn" class="minimal-btn play-btn" disabled title="Play/Pause">
                        <i id="playPauseIcon" class="fas fa-play"></i>
                    </button>

                    <button id="forwardBtn" class="minimal-btn forward-btn" disabled title="Avançar 10s">
                        <i class="fas fa-forward-step"></i>
                    </button>

                    <button id="logoutBtn" class="minimal-btn logout-btn" title="Sair">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>

                <div class="progress-section">
                    <div class="time-display">
                        <span id="currentTime">00:00</span>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="progress" class="progress-fill"></div>
                            </div>
                        </div>
                        <span id="duration">00:00</span>
                    </div>
                </div>
            </div>

            <audio id="audioPlayer" preload="none"></audio>
            <!-- Painel local de Markdown (exibido apenas em modo local) -->
            <div id="localMarkdowns"
                style="display:none; max-width:760px; margin:28px auto 0; background:rgba(15,19,22,0.92); border:1px solid #2a2e32; border-radius:12px; padding:24px; backdrop-filter:blur(8px);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <h3
                        style="margin:0; font-size:18px; color:#e2eef6; font-weight:600; display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-file-alt"></i> Arquivos Markdown (Modo Local)
                    </h3>
                    <button type="button" id="closeLocalMdBtn" title="Fechar"
                        style="background:#2a2e32; border:1px solid #3a4e5e; color:#cfe3f1; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px; display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>
                <div id="localMarkdownsContent" style="font-size:15px; line-height:1.7; color:#cfe3f1;"></div>
            </div>
        </div>

        <input type="checkbox" id="localModeToggle" checked style="display:none;">
        <select id="trackSelect" style="display:none;"></select>
        <button id="clearLocalBtn" type="button" style="display:none;"></button>

        <!-- Dados iniciais do servidor (se houver pacote carregado) -->
        {% if initial and initial.audio_url %}
        <div id="initialAudio" data-audio-url="{{ initial.audio_url }}" data-title="{{ initial.title }}"
            style="display:none;"></div>
        {% endif %}

        <!-- Input de arquivo STANDALONE (sem formulário para evitar submit ao servidor) -->
        <input type="file" id="fileInput" name="magFile" accept=".mag,.zip" style="display:none;">
    </div>

    <div id="uploadOverlay">
        <div class="spinner"></div>
        <div style="font-size:14px; opacity:0.9;">Processando arquivo localmente…</div>
        <div style="font-size:12px; opacity:0.7; margin-top:4px;">Aguarde...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="{% static 'js/player.js' %}"></script>
</body>

</html>