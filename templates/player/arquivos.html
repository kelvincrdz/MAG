{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAG Player - Arquivos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        body {
            background: linear-gradient(135deg, #0a0e12 0%, #1a1f26 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .files-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .files-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(15, 19, 22, 0.9);
            border-radius: 12px;
            border: 1px solid #2a2e32;
            backdrop-filter: blur(10px);
        }

        .files-header h2 {
            margin: 0;
            color: #e2eef6;
            font-size: 24px;
            font-weight: 600;
        }

        .nav-actions {
            display: flex;
            gap: 12px;
        }

        .minimal-link {
            padding: 10px 16px;
            border: 1px solid #3a4e5e;
            border-radius: 8px;
            color: #cfe3f1;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(42, 46, 50, 0.4);
        }

        .minimal-link:hover {
            background: rgba(62, 70, 80, 0.6);
            border-color: #5a7e9e;
            transform: translateY(-2px);
        }

        .content-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            align-items: start;
        }

        @media (max-width: 1200px) {
            .content-layout {
                grid-template-columns: 1fr;
            }
        }

        .markdown-section {
            background: rgba(15, 19, 22, 0.9);
            border-radius: 12px;
            border: 1px solid #2a2e32;
            padding: 24px;
            backdrop-filter: blur(10px);
        }

        .markdown-body {
            color: #cfe3f1;
            line-height: 1.8;
            font-size: 15px;
            word-wrap: break-word;
        }

        .markdown-body h1 {
            color: #e2eef6;
            font-size: 32px;
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #3a4e5e;
            font-weight: 700;
            line-height: 1.3;
        }

        .markdown-body h2 {
            color: #d5e5f2;
            font-size: 26px;
            margin-top: 32px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.4;
        }

        .markdown-body h3 {
            color: #c5dae8;
            font-size: 20px;
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 600;
            line-height: 1.4;
        }

        .markdown-body h4 {
            color: #b5cad8;
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .markdown-body h5 {
            color: #a5bac8;
            font-size: 16px;
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .markdown-body h6 {
            color: #95aab8;
            font-size: 15px;
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .markdown-body p {
            margin-bottom: 16px;
            margin-top: 0;
        }

        .markdown-body strong {
            font-weight: 700;
            color: #e2eef6;
        }

        .markdown-body em {
            font-style: italic;
        }

        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 16px;
            margin-top: 0;
            padding-left: 28px;
        }

        .markdown-body li {
            margin-bottom: 8px;
        }

        .markdown-body li>p {
            margin-bottom: 8px;
        }

        .markdown-body code {
            background: rgba(42, 46, 50, 0.6);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 13px;
            color: #f0a8d0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .markdown-body pre {
            background: rgba(10, 14, 18, 0.8);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            border: 1px solid #2a2e32;
            margin: 16px 0;
        }

        .markdown-body pre code {
            background: none;
            padding: 0;
            color: #88d4f5;
        }

        .markdown-body blockquote {
            border-left: 4px solid #5a7e9e;
            padding-left: 16px;
            margin: 16px 0;
            color: #9fb3c8;
            font-style: italic;
        }

        .markdown-body a {
            color: #6bb6ff;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s;
        }

        .markdown-body a:hover {
            border-bottom-color: #6bb6ff;
        }

        .markdown-body hr {
            border: none;
            border-top: 1px solid #3a4e5e;
            margin: 24px 0;
        }

        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        .markdown-body th,
        .markdown-body td {
            padding: 10px;
            border: 1px solid #2a2e32;
            text-align: left;
        }

        .markdown-body th {
            background: rgba(42, 46, 50, 0.6);
            font-weight: 600;
        }

        .markdown-body img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 16px 0;
        }

        .markdown-body del {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .md-file-name {
            color: #9fb3c8;
            font-size: 13px;
            margin-bottom: 16px;
            padding: 8px 12px;
            background: rgba(42, 46, 50, 0.4);
            border-radius: 6px;
            display: inline-block;
        }

        .audio-sidebar {
            background: rgba(15, 19, 22, 0.9);
            border-radius: 12px;
            border: 1px solid #2a2e32;
            padding: 20px;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 20px;
        }

        .audio-sidebar h3 {
            margin: 0 0 20px 0;
            color: #e2eef6;
            font-size: 18px;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 1px solid #3a4e5e;
        }

        .audio-item {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(42, 46, 50, 0.3);
            border-radius: 8px;
            border: 1px solid #2a2e32;
            transition: all 0.3s;
        }

        .audio-item:hover {
            background: rgba(52, 56, 60, 0.4);
            border-color: #3a4e5e;
        }

        .audio-item audio {
            width: 100%;
            margin-bottom: 8px;
            border-radius: 6px;
        }

        .audio-item span {
            color: #cfe3f1;
            font-size: 13px;
            display: block;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9fb3c8;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="files-container">
        <div class="files-header">
            <h2>Arquivos do Pacote</h2>
            <div class="nav-actions">
                <a class="minimal-link" href="{% url 'player_with_package' pkg_id %}">
                    <i class="fas fa-headphones"></i> Voltar ao Player
                </a>
                <a class="minimal-link" href="/logout/">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>

        <div class="local-mode-bar"
            style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; background: rgba(15,19,22,0.9); border:1px solid #2a2e32; border-radius:12px; padding:14px;">
            <label style="font-size:13px; color:#cfe3f1; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" id="localModeToggle" checked>
                Modo local (não enviar arquivo)
            </label>
            <label for="fileInput" class="minimal-link" style="cursor:pointer;">
                <i class="fas fa-folder-open"></i> Selecionar .mag local
            </label>
            <button id="clearLocalBtn" type="button" class="minimal-link" style="cursor:pointer; border:none;">
                <i class="fas fa-trash"></i> Limpar pacote salvo
            </button>
        </div>

        <div class="content-layout">
            <div class="markdown-section">
                {% if markdowns %}
                {% for md in markdowns %}
                <div class="md-file-name">
                    <i class="fas fa-file-alt" style="margin-right:6px;"></i>{{ md.name }}
                </div>
                <div class="markdown-body">{{ md.html|safe }}</div>
                {% if not forloop.last %}
                <hr style="border:none; border-top:1px solid #2a2e32; margin:32px 0;">
                {% endif %}
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-file-alt" style="font-size:48px; margin-bottom:16px; opacity:0.3;"></i>
                    <p>Nenhum arquivo Markdown encontrado neste pacote.</p>
                </div>
                {% endif %}

                <div id="localMarkdowns" class="markdown-body" style="display:none; margin-top:16px;"></div>
            </div>

            <div class="audio-sidebar">
                <h3>
                    <i class="fas fa-music" style="margin-right:8px;"></i>Reprodutor
                </h3>
                {% if audio_files %}
                <div style="margin-bottom:12px;">
                    <label for="trackSelect" style="color:#cfe3f1; font-size:13px; margin-right:8px;">Selecionar
                        faixa:</label>
                    <select id="trackSelect"
                        style="width:100%; background:#0f1316; color:#cfe3f1; border:1px solid #3a4e5e; padding:8px 10px; border-radius:8px;">
                        {% for a in audio_files %}
                        <option value="{{ a.url }}">{{ forloop.counter }}. {{ a.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Dados iniciais para o JS (compatível com player.js) #}
                <div id="initialAudio" data-audio-url="{{ audio_files.0.url }}" data-title="{{ audio_files.0.name }}"
                    style="display:none;"></div>

                {# Form de upload oculto para compatibilidade com player.js #}
                <form id="uploadForm" action="{% url 'upload_mag' %}" method="post" enctype="multipart/form-data"
                    style="display:none;">
                    {% csrf_token %}
                    <input type="file" id="fileInput" name="magFile" accept=".mag,.zip">
                </form>

                <div class="cassette-wrapper" style="transform:scale(0.85); transform-origin: top left;">
                    <div class="cassette-player">
                        <div class="cassette-container">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 810 513.5" class="cassette-svg">
                                <defs>
                                    <filter id="subtleBlueGlow" x="-20%" y="-20%" width="140%" height="140%">
                                        <feColorMatrix type="matrix"
                                            values="0.1 0.1 0.3 0 0.05  0.1 0.2 0.4 0 0.1    0.2 0.3 0.6 0 0.15  0   0   0   1 0"
                                            result="blueish" />
                                        <feGaussianBlur in="blueish" stdDeviation="1.5" result="blur" />
                                        <feMerge>
                                            <feMergeNode in="blur" />
                                            <feMergeNode in="SourceGraphic" />
                                        </feMerge>
                                    </filter>
                                </defs>
                                <g id="Tape">
                                    <g id="Tape1">
                                        <g id="TapeReel">
                                            <circle cx="234" cy="234" r="160" fill="#1a1a1a"
                                                class="tape-reel tape1-main" id="tape1-main"></circle>
                                            <circle cx="234" cy="234" r="140" stroke="#333" fill="none"
                                                class="tape-reel tape1-ring1" id="tape1-ring1"></circle>
                                            <circle cx="234" cy="234" r="120" stroke="#333" fill="none"
                                                class="tape-reel tape1-ring2" id="tape1-ring2"></circle>
                                            <circle cx="234" cy="234" r="100" stroke="#333" fill="none"
                                                class="tape-reel tape1-ring3" id="tape1-ring3"></circle>
                                        </g>
                                        <circle cx="234" cy="234" r="86.05" fill="#f2f2f2" />
                                        <circle cx="234" cy="234" r="40.49" fill="#bfbfbf" />
                                        <rect x="246.52" y="198.18" width="10.12" height="10.12"
                                            transform="translate(133.98 -98.04) rotate(29.74)" fill="#f2f2f2" />
                                        <rect x="211.36" y="259.7" width="10.12" height="10.12"
                                            transform="translate(159.87 -72.49) rotate(29.74)" fill="#f2f2f2" />
                                        <rect x="264.37" y="228.74" width="10.12" height="10.12"
                                            transform="translate(501.7 -36.95) rotate(89.68)" fill="#f2f2f2" />
                                        <rect x="193.51" y="229.14" width="10.12" height="10.12"
                                            transform="translate(431.64 34.31) rotate(89.68)" fill="#f2f2f2" />
                                        <rect x="210.95" y="198.41" width="10.12" height="10.12"
                                            transform="translate(-73.39 137.84) rotate(-30.51)" fill="#f2f2f2" />
                                        <rect x="246.93" y="259.46" width="10.12" height="10.12"
                                            transform="translate(-99.41 164.56) rotate(-30.51)" fill="#f2f2f2" />
                                        <circle cx="234" cy="234" r="24.18" fill="#1a1a1a" />
                                        <polygon points="234 198.38 203.15 251.81 264.85 251.81 234 198.38"
                                            fill="#1a1a1a" />
                                        <line x1="234" y1="198.38" x2="234" y2="234" fill="none" stroke="#f2f2f2"
                                            stroke-miterlimit="10" />
                                        <line x1="203.15" y1="251.81" x2="234" y2="234" fill="none" stroke="#f2f2f2"
                                            stroke-miterlimit="10" />
                                        <line x1="264.85" y1="251.81" x2="234" y2="234" fill="none" stroke="#f2f2f2"
                                            stroke-miterlimit="10" />
                                    </g>
                                    <g id="Tape2">
                                        <g id="TapeReel2">
                                            <circle cx="576" cy="234" r="85" fill="#1a1a1a" class="tape-reel tape2-main"
                                                id="tape2-main"></circle>
                                            <circle cx="576" cy="234" r="65" stroke="#333" fill="none"
                                                class="tape-reel tape2-ring1" id="tape2-ring1"></circle>
                                            <circle cx="576" cy="234" r="45" stroke="#333" fill="none"
                                                class="tape-reel tape2-ring2" id="tape2-ring2"></circle>
                                            <circle cx="576" cy="234" r="25" stroke="#333" fill="none"
                                                class="tape-reel tape2-ring3" id="tape2-ring3"></circle>
                                        </g>
                                        <circle cx="576" cy="234" r="86.05" fill="#f2f2f2" />
                                        <circle cx="576" cy="234" r="40.49" fill="#bfbfbf" />
                                        <rect x="588.52" y="198.18" width="10.12" height="10.12"
                                            transform="translate(179.04 -267.72) rotate(29.74)" fill="#f2f2f2" />
                                        <rect x="553.36" y="259.7" width="10.12" height="10.12"
                                            transform="translate(204.94 -242.17) rotate(29.74)" fill="#f2f2f2" />
                                        <rect x="606.37" y="228.74" width="10.12" height="10.12"
                                            transform="translate(841.77 -378.94) rotate(89.68)" fill="#f2f2f2" />
                                        <rect x="535.51" y="229.14" width="10.12" height="10.12"
                                            transform="translate(771.71 -307.68) rotate(89.68)" fill="#f2f2f2" />
                                        <rect x="552.95" y="198.41" width="10.12" height="10.12"
                                            transform="translate(-26.04 311.47) rotate(-30.51)" fill="#f2f2f2" />
                                        <rect x="588.93" y="259.46" width="10.12" height="10.12"
                                            transform="translate(-52.05 338.19) rotate(-30.51)" fill="#f2f2f2" />
                                        <circle cx="576" cy="234" r="24.18" fill="#1a1a1a" />
                                        <polygon points="576 198.38 545.15 251.81 606.85 251.81 576 198.38"
                                            fill="#1a1a1a" />
                                        <line x1="576" y1="198.38" x2="576" y2="234" fill="none" stroke="#f2f2f2"
                                            stroke-miterlimit="10" />
                                        <line x1="545.15" y1="251.81" x2="576" y2="234" fill="none" stroke="#f2f2f2"
                                            stroke-miterlimit="10" />
                                        <line x1="606.85" y1="251.81" x2="576" y2="234" fill="none" stroke="#f2f2f2"
                                            stroke-miterlimit="10" />
                                    </g>
                                </g>
                                <g id="Cassette">
                                    <path
                                        d="M780.41,0H29.59A20.59,20.59,0,0,0,9,20.59V483.41A20.59,20.59,0,0,0,29.59,504H780.41A20.59,20.59,0,0,0,801,483.41V20.59A20.59,20.59,0,0,0,780.41,0ZM297,189H513v90H297ZM220.5,486A13.5,13.5,0,1,1,234,472.5,13.49,13.49,0,0,1,220.5,486ZM234,279a45,45,0,1,1,45-45A45,45,0,0,1,234,279Zm58.5,198A13.5,13.5,0,1,1,306,463.5,13.49,13.49,0,0,1,292.5,477Zm225,0A13.5,13.5,0,1,1,531,463.5,13.49,13.49,0,0,1,517.5,477Zm72,9A13.5,13.5,0,1,1,603,472.5,13.49,13.49,0,0,1,589.5,486ZM576,279a45,45,0,1,1,45-45A45,45,0,0,1,576,279Z"
                                        fill="#2a2e32" />
                                    <path
                                        d="M654.47,501.21,631.65,394.7a9.74,9.74,0,0,0-9.53-7.7H187.88a9.74,9.74,0,0,0-9.53,7.7L155.53,501.21A9.74,9.74,0,0,0,165.06,513H644.94A9.74,9.74,0,0,0,654.47,501.21ZM220.5,486A13.5,13.5,0,1,1,234,472.5,13.49,13.49,0,0,1,220.5,486Zm72-9A13.5,13.5,0,1,1,306,463.5,13.49,13.49,0,0,1,292.5,477Zm225,0A13.5,13.5,0,1,1,531,463.5,13.49,13.49,0,0,1,517.5,477Zm72,9A13.5,13.5,0,1,1,603,472.5,13.49,13.49,0,0,1,589.5,486Z"
                                        fill="#2a2e32" stroke="#c5d1d6" stroke-miterlimit="10" />
                                    <rect x="297" y="189" width="216" height="90" fill="#2a2e32" opacity="0.67" />
                                    <rect y="288" width="18" height="144" rx="3.98" fill="#2a2e32" />
                                    <rect x="792" y="288" width="18" height="144" rx="3.98" fill="#2a2e32" />
                                </g>
                                <g id="Label">
                                    <path d="M45,36V369H765V36ZM648,297H162V171H648Z" fill="#bfbfbf" />
                                    <rect x="45" y="36" width="720" height="27" fill="#ec1d25" />
                                    <rect x="45" y="63" width="720" height="81" fill="#f2f2f2" />
                                    <rect x="45" y="315" width="720" height="54" fill="#1a1a1a" />
                                    <text x="405" y="55" text-anchor="middle" fill="white"
                                        font-family="Arial, sans-serif" font-size="18" font-weight="bold">MAG
                                        PLAYER</text>
                                    <text x="405" y="110" text-anchor="middle" fill="#333"
                                        font-family="Arial, sans-serif" font-size="12" id="songTitle">Selecione uma
                                        faixa</text>
                                    <text x="405" y="125" text-anchor="middle" fill="#666"
                                        font-family="Arial, sans-serif" font-size="10" id="songInfo">Reprodutor de Audio
                                        Digital</text>
                                </g>
                            </svg>
                        </div>

                        <div class="controls-panel">
                            <div class="main-controls">
                                <button id="openBtn" class="minimal-btn open-btn" title="Abrir arquivo"
                                    style="display:none;">
                                    <i class="fas fa-folder-open"></i>
                                </button>
                                <button id="rewindBtn" class="minimal-btn rewind-btn" disabled title="Retroceder 10s">
                                    <i class="fas fa-backward-step"></i>
                                </button>
                                <button id="playPauseBtn" class="minimal-btn play-btn" disabled title="Play/Pause">
                                    <i id="playPauseIcon" class="fas fa-play"></i>
                                </button>
                                <button id="forwardBtn" class="minimal-btn forward-btn" disabled title="Avançar 10s">
                                    <i class="fas fa-forward-step"></i>
                                </button>
                            </div>

                            <div class="progress-section">
                                <div class="time-display">
                                    <span id="currentTime">00:00</span>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div id="progress" class="progress-fill"></div>
                                        </div>
                                    </div>
                                    <span id="duration">00:00</span>
                                </div>
                            </div>

                            <div class="bottom-controls">
                                <button id="logoutBtn" class="minimal-btn logout-btn" title="Sair">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>

                        <audio id="audioPlayer" preload="none"></audio>
                    </div>
                </div>
                {% else %}
                <div class="empty-state" style="padding:20px;">
                    <i class="fas fa-music" style="font-size:32px; margin-bottom:12px; opacity:0.3;"></i>
                    <p style="font-size:13px;">Nenhum áudio nesta pasta.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# Form de upload fallback quando não há audio_files do servidor #}
    <form id="uploadForm" action="{% url 'upload_mag' %}" method="post" enctype="multipart/form-data"
        style="display:none;">
        {% csrf_token %}
        <input type="file" id="fileInput" name="magFile" accept=".mag,.zip">
    </form>

    <div id="uploadOverlay">
        <div class="spinner"></div>
        <div style="font-size:14px; opacity:0.9;">Enviando arquivo…</div>
        <div style="font-size:12px; opacity:0.7; margin-top:4px;">Não feche esta página.</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="{% static 'js/player.js' %}"></script>
</body>

</html>